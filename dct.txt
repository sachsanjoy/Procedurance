import pandas as pd
from statsmodels.tsa.statespace.sarimax import SARIMAX
from statsmodels.tsa.stattools import adfuller
import numpy as np

def sarima_forecast(df, date_col, target_col, order, seasonal_order):
    """
    Fit a SARIMA model on the time series data and forecast the next date.

    Parameters:
    df (pd.DataFrame): The time series data containing a date column and target column.
    date_col (str): The name of the date column in the dataframe.
    target_col (str): The name of the target (dependent) variable in the dataframe.
    order (tuple): The (p,d,q) order of the SARIMA model.
    seasonal_order (tuple): The seasonal (P,D,Q,s) order of the SARIMA model.

    Returns:
    pd.DataFrame: The original dataframe with a forecast of the next date.
    float: The forecasted value for the next date.
    """
    # Ensure the date column is in datetime format
    df[date_col] = pd.to_datetime(df[date_col])
    df.set_index(date_col, inplace=True)

    # Check if the target column is stationary, if not, difference the data
    adf_result = adfuller(df[target_col])
    print(f'ADF Statistic: {adf_result[0]}')
    print(f'p-value: {adf_result[1]}')

    if adf_result[1] > 0.05:
        print("The time series is not stationary, differencing might be required.")
    
    # Fit the SARIMA model
    model = SARIMAX(df[target_col], order=order, seasonal_order=seasonal_order, enforce_stationarity=False, enforce_invertibility=False)
    sarima_model = model.fit(disp=False)

    # Forecasting the next time step (out-of-sample)
    forecast = sarima_model.get_forecast(steps=1)
    forecast_value = forecast.predicted_mean[0]
    conf_int = forecast.conf_int()

    # Print forecast and confidence interval
    print(f'Forecasted Value: {forecast_value}')
    print(f'Confidence Interval: \n{conf_int}')

    # Create a new row with the forecasted value
    last_date = df.index[-1]
    next_date = last_date + pd.DateOffset(1)  # Assuming daily frequency

    # Append the forecast to the dataframe
    df_forecasted = df.copy()
    df_forecasted.loc[next_date] = np.nan
    df_forecasted[target_col].iloc[-1] = forecast_value  # Fill the forecasted value

    return df_forecasted, forecast_value




# Sample data
data = {
    'Date': pd.date_range(start='2020-01-01', periods=100, freq='D'),
    'Value': np.random.rand(100) * 100
}

df = pd.DataFrame(data)

# Model parameters (example: SARIMA(1,1,1)(1,1,1,12))
order = (1, 1, 1)
seasonal_order = (1, 1, 1, 12)

# Forecast next point
df_forecasted, forecast_value = sarima_forecast(df, 'Date', 'Value', order, seasonal_order)

print(f"Next predicted value: {forecast_value}")
