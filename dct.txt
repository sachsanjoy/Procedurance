import pandas as pd
import xlsxwriter
import random
import string

def generate_dummy_data(output_csv):
    # Generate 100 rows of dummy data
    data = {
        "Year": [random.choice(range(2010, 2023)) for _ in range(100)],
        "Breakdown_category": [random.choice(["Agriculture", "Manufacturing", "Healthcare", "Technology", "Education"]) for _ in range(100)],
        "RD_Value": [random.uniform(50, 500) for _ in range(100)],
        "Status": [random.choice(["Active", "Inactive"]) for _ in range(100)],
        "Unit": [random.choice(["NZD", "USD", "EUR"]) for _ in range(100)]
    }
    
    # Create a DataFrame and save to CSV
    df = pd.DataFrame(data)
    df.to_csv(output_csv, index=False)
    print(f"Dummy data saved to '{output_csv}'.")

def create_excel_with_charts(input_csv, output_excel):
    # Load the data
    data = pd.read_csv(input_csv, encoding='ISO-8859-1')

    # Initialize the workbook
    workbook = xlsxwriter.Workbook(output_excel)

    # Define summaries for pivot-like data
    summaries = [
        ("Total RD Expenditure by Year", data.groupby("Year")["RD_Value"].sum().reset_index()),
        ("Total RD Expenditure by Category", data.groupby("Breakdown_category")["RD_Value"].sum().reset_index()),
        ("Average RD Value by Year and Category", data.groupby(["Year", "Breakdown_category"])["RD_Value"].mean().reset_index()),
    ]

    for sheet_name, summary_data in summaries:
        # Add a worksheet
        worksheet = workbook.add_worksheet(sheet_name[:31])  # Limit sheet name to 31 characters

        # Write the data headers
        for col_num, column_title in enumerate(summary_data.columns):
            worksheet.write(0, col_num, column_title)

        # Write the data rows
        for row_num, row in enumerate(summary_data.itertuples(index=False), start=1):
            worksheet.write_row(row_num, 0, row)

        # Create a chart
        chart = workbook.add_chart({'type': 'column'})
        chart.set_title({'name': sheet_name})

        # Configure the chart
        chart.add_series({
            'name':       summary_data.columns[1],
            'categories': [sheet_name[:31], 1, 0, len(summary_data), 0],
            'values':     [sheet_name[:31], 1, 1, len(summary_data), 1],
        })

        # Insert the chart into the worksheet
        worksheet.insert_chart("E2", chart)

    # Close the workbook
    workbook.close()

# File paths
output_csv = 'dummy_data.csv'
input_csv = output_csv
output_excel = 'rd_analysis.xlsx'

# Generate dummy data
generate_dummy_data(output_csv)

# Generate the Excel file
create_excel_with_charts(input_csv, output_excel)
print(f"Excel file '{output_excel}' created successfully.")
